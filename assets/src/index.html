<!DOCTYPE html>
<html lang="en">
	<head>
		<script src="../forge/all.js"></script>
		<script src="js/jquery-1.7.2.min.js"></script>
		<script src="js/bootstrap.min.js"></script>
		<script src="http://da189i1jfloii.cloudfront.net/js/kinvey-js-0.9.14.min.js"></script>
		<script src="js/fetchnotes.js"></script>
		<script src="js/database.js"></script>
		
		<script src="js/rangy-core.js"></script>
		<script src="js/rangy-cssclassapplier.js"></script>
		<script src="js/rangy-selectionsaverestore.js"></script>
		<script src="js/rangy-serializer.js"></script>
		<link href="css/bootstrap.css" rel="stylesheet">
		<link href="css/bootstrap-responsive.css" rel="stylesheet">
		<script>

		/*var complete = function(){
				//soon this is going to be dropTables or something
				forge.internal.call("database.createTables",{schema: window.tables},
					function(){
						var db = new Database();

						var models = [
							new Kinvey.Entity({
								text: '#email your mother bout caves. and #gold',
								entities:{hashtags:["#gold", "#email"]},
								id: "fosidfjoai",
							},'notes'),
							new Kinvey.Entity({
								text: 'mmmmmmmm... #gold',
								entities:{hashtags: ["#gold"]},
								id: "fosasdfoai"
							},'notes'),
							new Kinvey.Entity({
								text: '#todo eat some #gold #bars to get your fiber',
								entities:{hashtags:["#todo", "#gold", "#bars"]},
								id: "fdsoai"
							},'notes'),
							new Kinvey.Entity({
								text: 'sb#email foo hundred #bars',
								entities:{hashtags:["#email", "#bars"]},
								id: "fdsapeshiti"
							},'notes'),
							new Kinvey.Entity({
								text: '#woot yeah',
								entities:{hashtags:["#woot"]},
								id: "lolsecksi"
							},'notes')
						];

						function changeNotes (models) {
							models[0].set('text', "#woot yeah day bow bow, chick, chick, chick-a");
							models[0].set('entities', {hashtags: ['#woot']});

							models[2].set('text', '#todo be sure to get 8000g of #fiber nightly');
							models[2].set('entities', {hashtags: ['#todo']});

							models[3].set('text', '#todo finish your test cases, n00bsauce #woot yeah #babbage');
							models[3].set('entities', {hashtags: ['#todo', '#woot', '#babbage']});
						}

						//returns modified models array
						function deleteNotes (models) {

						}

						var allHashtags = _.sortBy([
							{name: '#gold', count:3},
							{name: '#email', count:2},
							{name: '#todo', count:1},
							{name: '#bars', count: 2},
							 {name:'#woot', count:1}
							], function (item) {
								return item.name;
							});

						var changedHashtags = _.sortBy([
							{name: '#gold', count:1},
							{name: '#fiber', count:1},
							{name: '#babbage', count: 1},
							{name: '#todo', count:2},
							{name:'#woot', count:3}
							], function (item) {
								return item.name;
							});

						var afterDeletedHashtags =  _.sortBy([
							{name: '#woot', count: 1}
							], function (item) {
								return item.name;
							});

						const FAIL = 'You failed a test case F--';

						function error(err) {
							say('You really fucked up a test case');
						};

						function checkIDs (models, ids){
							var i = 0;
							for(i = 0; i < models.length; i++)
								if(models[i].get('localID') !== ids[i])
									return false
							return true;
						}

						function compare(object, kinvey) {
							var keys = Object.keys(object),
								i = 0;

							for(i = 0; i < keys.length; i++){
								var key = keys[i];
								if( (object[key] && kinvey.get(key)) && object[key] !== kinvey.get(key))
									return false;
							}

							return true;

						};


						function say(str) {
							console.log(str);
							//alert(str);
						}

						db.callAsync([
							{
								method: 'notes.create',
								model: models.slice(0,4),
								options:{
									success: function(ids){
										if ( checkIDs(models.slice(0,4), [1,2,3,4]) )
											say('Yay passed first test case');
										else
											say(FAIL);
									},
									error: error
								}

							},
							{
								method: 'notes.create',
								model: models[4],
								options: {
									success: function(ids){
										if ( checkIDs(models.slice(4), [5]) )
											say('Yay passed second test case');
										else
											say(FAIL);
									},
									error: error
								}
							},
							{
								method: 'notes.get',
								options: {
									success: function(notes) {
										var i = 0,
											result = notes.length === models.length;
										for(i = 0; i < notes.length; i++)
											if(!compare(notes[i], models[i]))
												result = false;
										if(result)
											say('yay passed third test case');
										else
											say(FAIL);

									},
									error: error
								}
							},
							{
								method: 'notes.get',
								options: {
									hashtags: ['#gold'],
									success: function(notes) {
										var i = 0,
											gModels = models.slice(0,3),
											result = notes.length === gModels.length;

										for (i = 0; i < notes.length; i++)
											if(!compare(notes[i], gModels[i]))
												result = false;
										if (result)
											say('yay passed fourth test case');
										else
											say(FAIL);

									},
									error: error
								}
							},
							{
								method: 'notes.get',
								options: {
									hashtags: ['#gold', '#bars'],
									success: function(notes) {
										var i = 0,
											gModels = models.slice(2,3),
											result = notes.length === gModels.length;

										for (i = 0; i < notes.length; i++)
											if(!compare(notes[i], gModels[i]))
												result = false;
										if (result)
											say('yay passed fifth test case like a boss');
										else
											say(FAIL);

									},
									error: error
								}
							},
							{
								method: 'notes.get',
								options: {
									hashtags: ['#woot', '#yeah'],
									success: function(notes) {
										if (!notes.length)
											say('yay passed sixth test case');
										else
											say(FAIL);

									},
									error: error
								}
							},
							{
								method: 'hashtags.get',
								options: {
									success: function (tags) {
										if (_.isEqual(tags,allHashtags))
											say('Yay you win the seventh test case');
										else
											say(FAIL);
									},
									error: error
								}
							},
							{
								method: 'hashtags.get',
								options: {
									hashtags: ["#gold"],
									success: function (tags) {
										if (_.isEqual(tags,_.sortBy([
											{name: '#gold', count: 3},
											{name: '#email', count: 1},
											{name: '#todo', count: 1},
											{name: '#bars', count: 1}
										],function (item) {
											return item.name;
										}))){
											say('Yay you win the eighth test case mofo!!!');
											changeNotes(models);//Get ready for the next round of tests!
										}else
											say(FAIL);
									},
									error: error
								}
							},
							{
								method: 'notes.update',
								model: models.slice(0,2),
								options: {
									dirty: true,
									success: function (ids) {
										if (models[0].get('status') === 'update' &&
											models[1].get('status') === 'update'){
											say('yay you won the ninth one');
										}else
											say(FAIL);

									},
									error: error
								}
							},
							{
								method: 'notes.update',
								model: models,
								options: {
									success: function (ids) {
										var i = 0,
											result = true;
										for (i = 0; i < models.length; i++)
											if (models[i].get('status') !== 'synced')
												result = false;

										if(result)
											say('yay you won the tenth one');
										else
											say(FAIL);
									},
									error: error
								}
							},
							{
								method: 'notes.get',
								options: {
									success: function(notes) {
										var i = 0,
											result = notes.length === models.length;
										for(i = 0; i < notes.length; i++)
											if(!compare(notes[i], models[i]))
												result = false;
										if(result)
											say('yay passed eleventh test case');
										else
											say(FAIL);


									},
									error: error
								}
							},
							{
								method: 'hashtags.get',
								options: {
									success: function (tags) {
										if (_.isEqual(tags, changedHashtags ))
											say('Yay you win the twelfth test case');
										else
											say(FAIL);
									},
									error: error
								}
							},
							{
								method: 'notes.delete',
								model: models.slice(3),
								options: {
									dirty: true,
									success: function (ids) {
										if (models[3].get('status') === 'delete' &&
											models[4].get('status') === 'delete'){
											say('Woot woot lucky number 13!!!');
										}else
											say(FAIL);

									},
									error: error
								}
							},
							{
								method: 'notes.delete',
								model: models.slice(1,4),
								options: {
									success: function (ids) {
										//no test, just setting things up for
										//next comparisons
										models = models.slice(0,1).concat(models[4]);
									},
									error: error
								}
							},
							{
								method: 'notes.get',
								options: {
									success: function(notes) {
										var i = 0,
											nonDeletedModels = models.slice(0,1),
											result = notes.length === nonDeletedModels.length;
										for (i = 0; i < notes.length; i++)
											if(!compare(notes[i], nonDeletedModels[i]))
													result = false;
										if (result)
											say('yay passed 14th test case like a boss');
										else
											say(FAIL);

										db.callAsync([
											{
												method: 'notes.clean',
												model: models[1],
												options: {
													success: function () {

													}
												}
											},
											{
												method: 'notes.get',
												options: {
													hashtags: ['#woot'],
													success: function(notes) {
														var i = 0,
															nonDeletedModels = models.slice(0,1),
															result = notes.length === nonDeletedModels.length;
														for (i = 0; i < notes.length; i++)
															if(!compare(notes[i], nonDeletedModels[i]))
																result = false;
														if (result)
															say('yay passed 15th test case woot yeah');
														else
															say(FAIL);
													},
													error: error
												}
											},
											{
												method: 'hashtags.get',
												options: {
													success: function (tags) {
														if( _.isEqual(afterDeletedHashtags, tags))
															say("16th test case is real good");
														else
															say(FAIL);
													forge.internal.call('database.multiQuery',
															{
																queries: [
																	"select * from Notes where id='poopshit'",
																	"select * from Notes where id='fosidfjoai'"
																]
															}
															,function (returned) {
																alert(JSON.stringify(returned));
															}
															);
													},
													error: error
												}
											}
										], db);

									},
									error: error
								}
							}
						],db);


					});
					}

		forge.internal.call('database.dropTables', {
				tables: window.tables.map(
					function(object){
						return object.name;
					}
				)
			}
			,complete
			,complete
			);
				function loopsiloo () {
		alert("setting dat range");
		document.getElementById('search-notes').setSelectionRange(3,3);
		setTimeout(loopsiloo, 5000);
	}();
	setInterval(function(){
		alert("setting dat range");
		document.getElementById('search-notes').setSelectionRange(3,3);
	}, 5000)
	
	*/
	
$(function () {
forge.internal.call('inspector.list', {}, function (methods) {
var modules = {};
for (method in methods) {
var parts = method.split('.');
apimethod = parts.pop();
var module = parts.join('.');
if (!modules[module]) {
modules[module] = {};
}
modules[module][apimethod] = methods[method];
}
for (module in modules) {
$('#_module').append('<option>'+module+'</option>');
}
$('#_module').change(function () {
var methods = modules[$(this).val()];
$('#_method').html('');
for (method in methods) {
$('#_method').append('<option>'+method+'</option>');
}
$('#_method').change();
})
$('#_module').change();
$('#_method').change(function () {
var module = $('#_module').val();
var method = $(this).val();
var params = modules[module][method];
$('.api_input').detach();
for (param in params) {
$('#_actions').before('<div class="control-group api_input"><label class="control-label" for="'+param+'">'+param+'</label><div class="controls"><input type="text" class="input-xlarge" id="'+param+'"></div></div>');
}
})
$('#_method').change();
$('#_run').click(function () {
var module = $('#_module').val();
var method = $('#_method').val();
var params = {};

$('.api_input input').each(function (i, x) {
params[$(x).attr('id')] = $(x).val();
});

document.getElementById('search-notes').focus();


$('#_output').prepend('<pre class="alert alert-info">Called "'+module+'.'+method+'" with "'+JSON.stringify(params, null, '')+'"</pre>');
forge.internal.call(module+'.'+method, params, function () {
$('#_output').prepend('<pre class="alert alert-success">Success for "'+module+'.'+method+'" with "'+JSON.stringify(arguments[0], null, '')+'"</pre>');

}, function () {
$('#_output').prepend('<pre class="alert alert-error">Error for "'+module+'.'+method+'" with "'+JSON.stringify(arguments[0], null, '')+'"</pre>');
})
});
}, function () {
alert("Error");
});
// forge.internal.addEventListener('*', function (event, e) {
// if (event == 'inspector.eventTriggered') {
// $('#_output').prepend('<pre class="alert alert-warning">Native event triggered "'+e.name+'"</pre>');
// } else if (event == 'inspector.eventInvoked') {
// if (e.class == 'ForgeEventListener') {
// $('#_output').prepend('<pre class="alert alert-warning">Default event listener for "'+e.name+'" called</pre>');
// } else {
// $('#_output').prepend('<pre class="alert alert-warning">Calling event listener "'+e.name+'" in class "'+e.class+'"</pre>');
// }
// } else {
// $('#_output').prepend('<pre class="alert alert-warning">Javascript event "'+event+'" triggered with data "'+JSON.stringify(e)+'"</pre>');
// }
// });
});

		</script>
	</head>
	<body>
		<div class="container">
			<div class="page-header">
				<h1>Input  <small>choose an API call to make</small></h1>
			</div>
			<textarea id="search-notes" placeholder= "Search Notes" /></textarea>
			<div class="form-actions" id="_actions">
				<button type="submit" class="btn btn-primary" id="_run">Run!</button>
			</div>
			<div class="form-horizontal">
					<div class="control-group">
						<label class="control-label" for="_module">Module</label>
						<div class="controls">
							<select id="_module">
							</select>
						</div>
					</div>
					<div class="control-group">
						<label class="control-label" for="_method">Method</label>
						<div class="controls">
							<select id="_method">
							</select>
						</div>
					</div>
			</div>
			<div class="page-header">
				<h1>Output <small>results from the API call, most recent at the top</small></h1>
			</div>
			<div id="_output">
			</div>
		</div>
	</body>
</html>

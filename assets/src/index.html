<!DOCTYPE html>
<html lang="en">
	<head>
		<script src="../forge/all.js"></script>
		<script src="js/jquery-1.7.2.min.js"></script>
		<script src="js/bootstrap.min.js"></script>
		<link href="css/bootstrap.css" rel="stylesheet">
		<link href="css/bootstrap-responsive.css" rel="stylesheet">
		<script>
			forge.internal.call('database.wipe',{})
			forge.internal.addEventListener("alert.resume", function () {
				alert("Weclome back!");
			});

      var FetchDB,
  __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };


var Fetch;

Fetch = {};


Fetch.regexp = {
  tags: /#[\w]+/g,
  contacts: /@[\w]+/g,
  urls: /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig,
  emails: /([a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,4})/ig
};

Fetch.findTags = function(str) {
  return str.replace(Fetch.regexp.urls, '').match(Fetch.regexp.tags) || [];
};

Fetch.findContacts = function(str) {
  return str.replace(Fetch.regexp.emails, '').match(Fetch.regexp.contacts) || [];
};

Fetch.findEmails = function(str) {
  return str.match(Fetch.regexp.emails) || [];
};

Fetch.findUrls = function(str) {
  return str.match(Fetch.regexp.urls) || [];
};

FetchDB = (function() {

  FetchDB.name = 'FetchDB';

  FetchDB.prototype.prepNativeCall = function(model, update) {
    var object, text;
    text = model['text'];
    if (!model['html']) {
      model.html = "lkdjflk"

    }
    return object = {
      model: model,
      entities: {
        tag: Fetch.findTags(text),
        contact: Fetch.findContacts(text),
        email: Fetch.findEmails(text),
        url: Fetch.findUrls(text)
      }
    };
  };

  FetchDB.prototype.localSave = function(args) {
    var model, object;
    if (window.forge) {
      this.modelArray || (this.modelArray = []);
      this.entityArray || (this.entityArray = []);
      model = args.model;
      object = this.prepNativeCall(model);
      this.modelArray.push(model);
      this.entityArray.push(object.entities);
      if (this.addTimer) clearTimeout(this.addTimer);
      return this.addTimer = setTimeout(this.addArrays, 20);
    } else {
      return console.log("no database!");
    }
  };

  FetchDB.prototype.addArrays = function() {
    var params, self;
    self = DB;
    params = {
      models: self.clearArray(self.modelArray),
      entities: self.clearArray(self.entityArray)
    };
    return forge.internal.call('database.put', params, function(ids) {
      var i, id, model, _i, _len, _ref, _results;
      console.log('note saved!');
      if (ids) {
        i = 0;
        _ref = params.models;
        _results = [];
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          model = _ref[_i];
          id = ids[i];
          model.localID = id

          _results.push(i++);
        }
        return _results;
      }
    }, function(e) {
      return console.log("trouble saving notes:\n" + (JSON.stringify(e)));
    });
  };

  FetchDB.prototype.clearArray = function(array) {
    var result;
    result = [];
    if (array) {
      while (array.length > 0) {
        result.push(array.pop());
      }
    }
    return result;
  };

  FetchDB.prototype.updateLocal = function(args) {
    var data, method, model, response;
    method = args.method;
    data = args.data;
    model = args.model;
    if (data) {
      response = data.response || JSON.parse(data).response;
     // model.set(this.translateServerNote(response));
    }
    if (method) model.sync = method;
    return this.localSave({
      model: model
    });
  };

  function FetchDB() {
    this.deleteLocal = __bind(this.deleteLocal, this);

    this.updateLocal = __bind(this.updateLocal, this);
    this.CHUNK_SIZE = 25;
    this.startIndex = 0;
  }

  FetchDB.prototype.deleteLocal = function(args) {
    if (window.forge) {
      return forge.internal.call('database.delete', {
        model: args.model
      });
    }
  };

  FetchDB.prototype.getNextNotes = function(success) {
    var _this = this;
    if (window.forge) {
      return forge.internal.call('database.getnext', {
        start: this.startIndex,
        chunkSize: this.CHUNK_SIZE
      }, function(notes) {
        success(notes);
        return _this.startIndex += _this.CHUNK_SIZE;
      }, function(error) {
        return console.log("problem getting notes:\n" + (JSON.stringify(error)));
      });
    }
  };

  FetchDB.prototype.getDirtyNotes = function(success) {
    if (window.forge) {
      return forge.internal.call('database.getdirty', {}, function(notes) {
        return success(notes);
      });
    }
  };

  FetchDB.prototype.getAllNotes = function() {
    return _.union(this.getSyncedNotes(), this.getDirtyNotes());
  };

  FetchDB.prototype.translateServerNote = function(note) {
    return {
      text: note.text,
      lastModified: note.timestamp,
      id: note._id,
      deleted: note.state === 'deleted' || note.state === 'unsubscribed'
    };
  };

  /*
  */


  return FetchDB;

})();


 fetchDate = function(milli) {
    milli || (milli = new Date().getTime());
    console.log("le milliseconds: " + milli);
    console.log("le offset: " + (new Date().getTimezoneOffset()));
    return new Date(milli).toISOString().replace('Z', '');
  }

console.log("++++++++++yay the date: "+fetchDate());

var DB = new FetchDB();

var model = {"text":"Foop a doop #email #fetchnotesghetto","html":"<p>Foop</p>","lastModified":"2012-11-17T01:09:05.464000","visible":true,"localID":"c46","sync":"create","id":"50a6e3b129d3690ca70007da"};
var model1 = {"text":"#poop","html":"<p><span class=\"tag\">#poop</span></p>","lastModified":"2012-11-17T01:12:58.742000","visible":true,"localID":"c25","sync":"create","id":"50a6e49a29d3690c9c000830"};
var model2 = {"text":"Woot #woot #email","html":"<p>Woot #woot</p>","lastModified":"2012-11-17T01:15:33.737000","visible":true,"localID":"c4","sync":"create","id":"50a6e53529d3690c8600084e"};
var model3 = {"text":"Aw no","html":"<p>Aw no</p>","lastModified":"2012-11-18T01:57:15.960000","visible":true,"localID":"c6","sync":"create","id":"50a8407b29d3690ca70008d2","deleted":false};


DB.localSave({"model":model});
DB.localSave({"model":model1});
DB.localSave({"model":model2});
DB.localSave({"model":model3});

/*var buildFetchQuery, buildQuery, buildTagsString;

buildTagsString = function(tags) {
  var tag;
  return ((function() {
    var _i, _len, _results;
    _results = [];
    for (_i = 0, _len = tags.length; _i < _len; _i++) {
      tag = tags[_i];
      _results.push("'" + tag + "'");
    }
    return _results;
  })()).join(',');
};

buildQuery = function(args) {
  return "select " + args.select + " from " + args.from + " where " + args.where + " in (" + args["in"] + ")";
};

buildFetchQuery = function(tags, start, end) {
  return "" + (buildQuery({
    select: '*',
    from: 'Notes',
    where: 'local_id',
    'in': buildQuery({
      select: 'distinct local_id',
      from: 'NoteTag',
      where: 'tag',
      'in': buildTagsString(tags)
    })
  })) + " order by last_updated desc limit " + start + "," + end;
}*/

var buildFetchQuery, buildIdsQuery;

buildIdsQuery = function(tags) {
  var tag;
  return ((function() {
    var _i, _len, _results;
    _results = [];
    for (_i = 0, _len = tags.length; _i < _len; _i++) {
      tag = tags[_i];
      _results.push("select distinct local_id from NoteTag where tag == '" + tag + "'");
    }
    return _results;
  })()).join(' intersect ');
};

buildFetchQuery = function(tags, start, end) {
  return ("select * from Notes where local_id in (" + (buildIdsQuery(tags)) + ")") + (" order by last_updated desc limit " + start + "," + end + ";");
};




setTimeout(function(){forge.internal.call('database.query',{query:buildFetchQuery(['#email','#fetchnotesghetto'],0,10)},function(result){console.log("woot success\n"+JSON.stringify(result))})},4000);

setTimeout(function(){forge.internal.call('database.query',{query:buildFetchQuery(['#email'],0,10)},function(result){console.log("woot success\n"+JSON.stringify(result))})},4000);



			$(function () {
				forge.internal.call('inspector.list', {}, function (methods) {
					var modules = {};
					for (method in methods) {
						var parts = method.split('.');
						apimethod = parts.pop();
						var module = parts.join('.');
						if (!modules[module]) {
							modules[module] = {};
						}
						modules[module][apimethod] = methods[method];
					}
					for (module in modules) {
						$('#_module').append('<option>'+module+'</option>');
					}
					$('#_module').change(function () {
						var methods = modules[$(this).val()];
						$('#_method').html('');
						for (method in methods) {
							$('#_method').append('<option>'+method+'</option>');
						}
						$('#_method').change();
					})
					$('#_module').change();
					$('#_method').change(function () {
						var module = $('#_module').val();
						var method = $(this).val();
						var params = modules[module][method];
						$('.api_input').detach();
						for (param in params) {
							$('#_actions').before('<div class="control-group api_input"><label class="control-label" for="'+param+'">'+param+'</label><div class="controls"><input type="text" class="input-xlarge" id="'+param+'"></div></div>');
						}
					})
					$('#_method').change();
					$('#_run').click(function () {
						var module = $('#_module').val();
						var method = $('#_method').val();
						var params = {};

						$('.api_input input').each(function (i, x) {
							params[$(x).attr('id')] = $(x).val();
						});

						$('#_output').prepend('<pre class="alert alert-info">Called "'+module+'.'+method+'" with "'+JSON.stringify(params, null, '')+'"</pre>');
						forge.internal.call(module+'.'+method, params, function () {
							console.log('poop poop poop poop');
							$('#_output').prepend('<pre class="alert alert-success">Success for "'+module+'.'+method+'" with "'+JSON.stringify(arguments[0], null, '')+'"</pre>');
						}, function () {
							$('#_output').prepend('<pre class="alert alert-error">Error for "'+module+'.'+method+'" with "'+JSON.stringify(arguments[0], null, '')+'"</pre>');
						})
					});

				}, function () {
					alert("Error");
				});
				// forge.internal.addEventListener('*', function (event, e) {
				// 	if (event == 'inspector.eventTriggered') {
				// 		$('#_output').prepend('<pre class="alert alert-warning">Native event triggered "'+e.name+'"</pre>');
				// 	} else if (event == 'inspector.eventInvoked') {
				// 		if (e.class == 'ForgeEventListener') {
				// 			$('#_output').prepend('<pre class="alert alert-warning">Default event listener for "'+e.name+'" called</pre>');
				// 		} else {
				// 			$('#_output').prepend('<pre class="alert alert-warning">Calling event listener "'+e.name+'" in class "'+e.class+'"</pre>');
				// 		}
				// 	} else {
				// 		$('#_output').prepend('<pre class="alert alert-warning">Javascript event "'+event+'" triggered with data "'+JSON.stringify(e)+'"</pre>');
				// 	}
				// });




			});
		</script>
	</head>
	<body>
		<div class="container">
			<div class="page-header">
				<h1>Input  <small>choose an API call to make</small></h1>
			</div>
			<textarea id="search-notes" placeholder= "Search Notes" /></textarea>
			<div class="form-horizontal">
					<div class="control-group">
						<label class="control-label" for="_module">Module</label>
						<div class="controls">
							<select id="_module">
							</select>
						</div>
					</div>
					<div class="control-group">
						<label class="control-label" for="_method">Method</label>
						<div class="controls">
							<select id="_method">
							</select>
						</div>
					</div>
					<div class="form-actions" id="_actions">
						<button type="submit" class="btn btn-primary" id="_run">Run!</button>
					</div>
			</div>
			<div class="page-header">
				<h1>Output <small>results from the API call, most recent at the top</small></h1>
			</div>
			<div id="_output">
			</div>
		</div>
	</body>
</html>
